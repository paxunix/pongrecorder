<head>
  <title>Dumb Pong Match Recorder</title>

  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">

  <style>
    .flex-center {
      display: flex;
      justify-content: center;
    }

    body {
      max-width: 20em;
    }

    select {
      width: 15em;
    }

    #saveMatch {
      margin: 0.5em;
    }

    #clearMatches {
      margin: 0.5em;
    }

    #mailMatches {
      margin: 0.5em;
    }

    #reset {
      margin: 0.5em;
    }

    #actionButtons {
      width: 100%;
    }

    .winlossButtons {
      padding-bottom: 1ex;
    }

    #matchdata {
      font-size: 10pt;
    }

    #matchdata ol {
      padding-left: 10px;
    }
  </style>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.18.1/URI.js"></script>

  <script>
    const STORAGE_KEY = "matchData";
    let players = [
      "baekc",
      "chengxw",
      "ddivyesh",
      "dmmalone",
      "georgyue",
      "gunterj",
      "haimobai",
      "halpenny",
      "jabeck",
      "locknerp",
      "markajo",
      "scarbro",
      "tomwdlw",
      "varshnes",
      "midha",
    ];

    players.sort();


    function switchTeamNumber(str)
    {
        if (str.search(/1/) !== -1) return str.replace(/1/, "2");
        if (str.search(/2/) !== -1) return str.replace(/2/, "1");
        throw new Error("unknown team id");
    }


    function hasSavedMatches()
    {
        return getMatches().length > 0;
    }


    function saveMatch(match)
    {
      let matchData = getMatches();
      matchData.push(match);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(matchData));
    }


    function getMatches()
    {
      let matchData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      return matchData;
    }


    function getWinLossStateForFieldsetId(set)
    {
      let $checked = jQuery(`#${set} input[type="radio"]:checked`);
      if ($checked.length === 0)
        return "";
      else if ($checked[0].id.search(/loss/) !== -1)
        return "l";

      return "w";
    }


    // Clears form inputs back to default state
    function resetStates()
    {
      jQuery('#1v1').prop("checked", false);
      jQuery('#2v2').prop("checked", true);

      jQuery('#t1-win,#t1-loss,#t2-win,#t2-loss').prop("checked", false);

      jQuery("#t1p2").selectmenu("widget").show();
      jQuery("#t2p2").selectmenu("widget").show();

      jQuery("#t1p1,#t1p2,#t2p1,#t2p2").val("");
      jQuery("#t1p1,#t1p2,#t2p1,#t2p2").selectmenu("refresh");

      jQuery('option[name^=player-]').prop("disabled", false);

      setStates();
    }


    // Call this after each UI changing event
    function setStates()
    {
      // Hide player 2 pulldowns on each team if 1v1 is selected, otherwise,
      // show them.
      let is1v1 = jQuery('#1v1').prop("checked");
      if (is1v1)
      {
        jQuery("#t1p2").selectmenu("widget").hide();
        jQuery("#t2p2").selectmenu("widget").hide();
      }
      else
      {
        jQuery("#t1p2").selectmenu("widget").show();
        jQuery("#t2p2").selectmenu("widget").show();
      }

      // Determine if a win/loss has been selected for each team (even if
      // 1v1, we can still retrieve team2's data)
      let t1WinLoss = getWinLossStateForFieldsetId("t1winlossButtons");
      let t2WinLoss = getWinLossStateForFieldsetId("t2winlossButtons");

      // First, ensure all player name options are enabled
      jQuery('option[name^=player-]').prop("disabled", false);

      // Then, disable each selected player in all other pulldowns
      let t1p1 = jQuery("#t1p1");
      let t1p2 = jQuery("#t1p2");
      let t2p1 = jQuery("#t2p1");
      let t2p2 = jQuery("#t2p2");

      for (el of [t1p1, t1p2, t2p1, t2p2])
      {
        let playerName = el.val();
        if (!playerName)
          continue;   // skip default selection

        // Disable all players of that name
        jQuery(`option[name="player-${playerName}"]`).prop("disabled", true);
        // Then re-enable the one that was originally set
        jQuery(`option[name="player-${playerName}"]`, el).prop("disabled", false);
      }

      // Reflect disabled/enabled changes to player names
      jQuery("#t1p1,#t1p2,#t2p1,#t2p2").selectmenu("refresh");

      // Save can only be done if required fields have values
      jQuery("#saveMatch").button(
        (is1v1 && (t1p1.val() && t2p1.val()) ||
          (t1p1.val() && t1p2.val() && t2p1.val() && t2p2.val())) &&
        t1WinLoss && t2WinLoss ? "enable" : "disable");

      // Mail can only be done if at least one match is saved
      jQuery("#mailMatches").button(hasSavedMatches() ? "enable" : "disable");
    }


    function winLossClick(evt)
    {
      let isWin = evt.target.id.search(/win/) !== -1;
      let prefix = evt.target.id.replace(/-.*$/, "");
      let otherTeamPrefix = switchTeamNumber(prefix);

      // Toggle the other team's win/loss buttons
      jQuery(`#${otherTeamPrefix}-${isWin ? "win" : "loss"}`).prop("checked", false).change();
      jQuery(`#${otherTeamPrefix}-${isWin ? "loss" : "win"}`).prop("checked", true).change();

      setStates();
    }


    function saveMatchClick(evt)
    {
      debugger;
      let match = {};
      let t1p1 = jQuery("#t1p1").val();
      let t1p2 = jQuery("#t1p2").val();
      let t2p1 = jQuery("#t2p1").val();
      let t2p2 = jQuery("#t2p2").val();
      let $t1winLoss = jQuery('#t1winlossButtons input[type="radio"]:checked:first');
      if ($t1winLoss.length > 0)
      {
        match.timestamp = (new Date).toISOString();

        if ($t1winLoss[0].id === "t1-win")
        {
          match.winTeam = [ t1p1, t1p2 ].filter(el => el).join(",");
          match.loseTeam = [ t2p1, t2p2 ].filter(el => el).join(",");
        }
        else
        {
          match.winTeam = [ t2p1, t2p2 ].filter(el => el).join(",");
          match.loseTeam = [ t1p1, t1p2 ].filter(el => el).join(",");
        }
      }

      saveMatch(match);
      displayMatchData();
    }


    function clearStoredMatches()
    {
      localStorage.removeItem(STORAGE_KEY);
    }


    function clearMatchesClick(evt)
    {
      clearStoredMatches();
      displayMatchData();
    }


    function mailMatchesClick(evt)
    {
      let body = [];
      for (let match of getMatches())
      {
        body.push(`/pong record \"${match.timestamp}\" w:${match.winTeam} l:${match.loseTeam}`);
      }

      //let url = new URI("mailto:automotive-pongbot@amazon.com");
      let url = new URI("mailto:paxunix@gmail.com");
      url.setSearch({
        subject: "Pong Match",
        body: body.join("\n"),
      });

      window.open(url.toString(), "pongbot mail window");
    }


    function displayMatchData()
    {
      // Iterate through locally saved match data and output mailto URLs
      // with match data.
      jQuery("#matchdata").html(hasSavedMatches() ? "<ol></ol>" : "You have no saved matches");

      for (let match of getMatches())
      {
        let matchRecordString = `w:${match.winTeam} l:${match.loseTeam}`;

        let url = new URI("mailto:automotive-pongbot@amazon.com");
        url.setSearch({
          subject: "Pong Match",
          body: `/pong record ${match.timestamp} ${matchRecordString}`,
        });

        let prettyTime = new Date(Date.parse(match.timestamp));
        let mailto = jQuery("<li>")
          //.attr("href", url.toString())
          .attr("title", prettyTime.toString())
          .text(matchRecordString)

        jQuery("#matchdata ol").append(mailto);
      }

      setStates();
    }


    jQuery(document).ready(function () {
      // Populate each select with all players
      for (selectId of ["t1p1", "t1p2", "t2p1", "t2p2"])
      {
        for (p of players)
        {
          let opt = jQuery("<option>").attr("name", `player-${p}`).text(p);
          jQuery(`#${selectId}`).append(opt);
        }
      }


      // Set event handlers and jQuery UI elements
      jQuery("#t1-win").click(winLossClick);
      jQuery("#t1-loss").click(winLossClick);
      jQuery("#t2-win").click(winLossClick);
      jQuery("#t2-loss").click(winLossClick);

      jQuery("#1v1").click(setStates);
      jQuery("#2v2").click(setStates);

      jQuery("#gameTypeButtons").buttonset({ items: "input" });
      jQuery("#t1winlossButtons").buttonset({ items: "input" });
      jQuery("#t2winlossButtons").buttonset({ items: "input" });

      jQuery("#t1p1").selectmenu({ select: setStates });
      jQuery("#t1p2").selectmenu({ select: setStates });
      jQuery("#t2p1").selectmenu({ select: setStates });
      jQuery("#t2p2").selectmenu({ select: setStates });

      jQuery("#saveMatch").click(saveMatchClick).button();
      jQuery("#reset").click(resetStates).button();
      jQuery("#mailMatches").click(mailMatchesClick).button();

      jQuery("#clearMatches").click(clearMatchesClick).button();

      displayMatchData();
    })
  </script>
</head>

<body>

  <fieldset id="gameTypeButtons">
    <legend>Game type</legend>
    <div class="flex-center">
      <label for="2v2">2v2</label>
      <input type="radio" name="gametype" id="2v2" checked="checked">
      <label for="1v1">1v1</label>
      <input type="radio" name="gametype" id="1v1">
    </div>
  </fieldset>

  <fieldset id="team1">
    <legend>Team 1</legend>

    <div id="t1winlossButtons" class="winlossButtons">
      <label for="t1-win">W</label>
      <input type="radio" name="t1winloss" id="t1-win">
      <label for="t1-loss">L</label>
      <input type="radio" name="t1winloss" id="t1-loss">
    </div>

    <select id="t1p1">
      <option value="" selected>Choose player...</option>
    </select>

    <select id="t1p2">
      <option value="" selected>Choose player...</option>
    </select>
  </fieldset>

  <fieldset id="team2" class="flex-center">
    <legend>Team 2</legend>

    <div id="t2winlossButtons" class="winlossButtons">
      <label for="t2-win">W</label>
      <input type="radio" name="t2winloss" id="t2-win">
      <label for="t2-loss">L</label>
      <input type="radio" name="t2winloss" id="t2-loss">
    </div>

    <div>
    <select id="t2p1">
      <option value="" selected>Choose player...</option>
    </select>
    </div>

    <select id="t2p2">
      <option value="" selected>Choose player...</option>
    </select>
  </fieldset>

  <div class="flex-center">
    <button id="saveMatch">Save</button>
    <button id="reset">Reset</button>
    <button id="mailMatches">Mail</button>
  </div>

  <fieldset id="matches">
    <legend>Local saved match data</legend>
    <div id="matchdata">
      <ol>
      </ol>
    </div>
  </fieldset>

  <div class="flex-center">
    <button id="clearMatches">Clear Saved Matches</button>
  </div>
</body>
