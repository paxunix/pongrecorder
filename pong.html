<head>
  <title>Dumb Pong Match Recorder</title>

  <link rel="shortcut icon" type-"image/png" href="pong.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    .leftspace {
      margin-left: 2em;
    }

    button {
      margin: 0.5em;
    }

    .winlossButtons {
      padding-bottom: 1ex;
    }

    #matchdata p {
      padding: 0px;
      margin: 0px;
    }

    #editPlayerList {
      height: 36ex;
      width: 100%;
    }

    .deleteGame {
      padding-left: 1em;
      padding-right: 1em;
      text-decoration: none;
    }

    .deleteGame:link, .deleteGame:visited, .deleteGame:hover, .deleteGame:active {
      color: red;
    }

    /* Player editing is hidden on load */
    .playerDataEntry {
      display: none;
    }

    /* Help is hidden on load */
    .helpContent {
      display: none;
      max-width: 300px;
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.18.1/URI.min.js"></script>

  <script>
    const STORAGE_KEY = "pongrecorder-matchData";
    const PLAYER_LIST_KEY = "pongrecorder-playerList";


    function switchTeamNumber(str)
    {
        if (str.search(/1/) !== -1) return str.replace(/1/, "2");
        if (str.search(/2/) !== -1) return str.replace(/2/, "1");
        throw new Error("unknown team id");
    }


    function hasSavedMatches()
    {
        return getMatches().length > 0;
    }


    function saveGame(game)
    {
      let matchData = getMatches();
      matchData.push(game);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(matchData));
    }


    function getMatches()
    {
      let matchData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      return matchData;
    }


    function getWinLossStateForFieldsetId(set)
    {
      let $checked = jQuery(`#${set} input[type="radio"]:checked`);
      if ($checked.length === 0)
        return "";
      else if ($checked[0].id.search(/loss/) !== -1)
        return "l";

      return "w";
    }


    // Clears form inputs back to default state
    function resetStates()
    {
      jQuery('#1v1').prop("checked", false);
      jQuery('#2v2').prop("checked", true);

      jQuery('#t1-win,#t1-loss,#t2-win,#t2-loss').prop("checked", false);

      jQuery("#t1p2").show();
      jQuery("#t2p2").show();

      jQuery("#t1p1,#t1p2,#t2p1,#t2p2").val("");

      jQuery('option[name^=player-]').prop("disabled", false);

      setStates();
    }


    // Call this after each UI changing event
    function setStates()
    {
      // Hide/show forms
      jQuery(".helpContent").hide();
      jQuery(".playerDataEntry").hide();
      jQuery(".dataEntry").show();

      // Hide player 2 pulldowns on each team if 1v1 is selected, otherwise,
      // show them.  Also, clear out each team's p2 if 1v1 is selected (this
      // avoids some potential state issues).
      let is1v1 = jQuery('#1v1').prop("checked");
      if (is1v1)
      {
        jQuery("#t1p2").hide().val("");
        jQuery("#t2p2").hide().val("");
      }
      else
      {
        jQuery("#t1p2").show();
        jQuery("#t2p2").show();
      }

      // Determine if a win/loss has been selected for each team (even if
      // 1v1, we can still retrieve team2's data)
      let t1WinLoss = getWinLossStateForFieldsetId("t1winlossButtons");
      let t2WinLoss = getWinLossStateForFieldsetId("t2winlossButtons");

      // First, ensure all player name options are enabled
      jQuery('option[name^=player-]').prop("disabled", false);

      // Then, disable each selected player in all other pulldowns
      let t1p1 = jQuery("#t1p1");
      let t1p2 = jQuery("#t1p2");
      let t2p1 = jQuery("#t2p1");
      let t2p2 = jQuery("#t2p2");

      for (el of [t1p1, t1p2, t2p1, t2p2])
      {
        let playerName = el.val();
        if (!playerName)
          continue;   // skip default selection

        // Disable all players of that name
        jQuery(`option[name="player-${playerName}"]`).prop("disabled", true);
        // Then re-enable the one that was originally set
        jQuery(`option[name="player-${playerName}"]`, el).prop("disabled", false);
      }

      // Save can only be done if required fields have values
      jQuery("#saveGame").prop("disabled",
        (is1v1 && (t1p1.val() && t2p1.val()) ||
          (!is1v1 && t1p1.val() && t1p2.val() &&
            t2p1.val() && t2p2.val())) &&
        t1WinLoss && t2WinLoss ? false : true);

      // Mail can only be done if at least one match is saved
      jQuery("#mailMatches").prop("disabled", hasSavedMatches() ? false : true);
    }


    function winLossClick(evt)
    {
      let isWin = evt.target.id.search(/win/) !== -1;
      let prefix = evt.target.id.replace(/-.*$/, "");
      let otherTeamPrefix = switchTeamNumber(prefix);

      // Toggle the other team's win/loss buttons
      jQuery(`#${otherTeamPrefix}-${isWin ? "win" : "loss"}`).prop("checked", false).change();
      jQuery(`#${otherTeamPrefix}-${isWin ? "loss" : "win"}`).prop("checked", true).change();

      setStates();
    }


    function saveGameClick(evt)
    {
      let game = {};
      let t1p1 = jQuery("#t1p1").val();
      let t1p2 = jQuery("#t1p2").val();
      let t2p1 = jQuery("#t2p1").val();
      let t2p2 = jQuery("#t2p2").val();
      let $t1winLoss = jQuery('#t1winlossButtons input[type="radio"]:checked:first');
      if ($t1winLoss.length > 0)
      {
        game.timestamp = (new Date).toISOString();

        if ($t1winLoss[0].id === "t1-win")
        {
          game.winTeam = [ t1p1, t1p2 ].filter(el => el);
          game.loseTeam = [ t2p1, t2p2 ].filter(el => el);

        }
        else
        {
          game.winTeam = [ t2p1, t2p2 ].filter(el => el);
          game.loseTeam = [ t1p1, t1p2 ].filter(el => el);
        }

        game.gameString =
          "w:" + game.winTeam.join(",") +
          " " +
          "l:" + game.loseTeam.join(",");
      }

      saveGame(game);
      displayMatchData();
    }


    function clearStoredMatches()
    {
      localStorage.removeItem(STORAGE_KEY);
    }


    function clearMatchesClick(evt)
    {
      if (window.confirm("Clear all saved matches?"))
      {
        clearStoredMatches();
        displayMatchData();
      }
    }


    function mailMatchesClick(evt)
    {
      let matches = getMatches();
      let timestamp = matches[0].timestamp;
      let matchStrings = matches.map(match => match.gameString).join("\n");
      let body = [
        `/pong record "${timestamp}"`,
        `${matchStrings}`,
        "",
        "Paste the above into the Mattermost Off-Topic channel to record these results.",
      ];
      let url = new URI("mailto:" + "automotive-pongbot" + "@" + "amazon.com");
      url.setSearch({
        subject: "Pong Result",
        body: body.join("\n")
      });

      window.open(url.toString(), "pongbot mail window");
    }


    function displayMatchData()
    {
      jQuery("#matchdata").html(hasSavedMatches() ? "" : "You have no saved games");

      let count = 0;
      for (let game of getMatches())
      {
        let prettyTime = new Date(Date.parse(game.timestamp));
        let deleteAnchor = jQuery("<a>")
          .addClass("deleteGame")
          .attr("data-offset", count)
          .attr("href", "#")
          .text("\u2573");      // a big X
        let span = jQuery("<span>")
          .addClass("gameString")
          .attr("data-gameresult", JSON.stringify({win: game.winTeam, lose: game.loseTeam}))
          .text(game.gameString);
        let item = jQuery("<p>")
          .attr("title", prettyTime.toString())
          .html(deleteAnchor[0].outerHTML + span[0].outerHTML);

        ++count;

        jQuery("#matchdata").append(item);
      }

      setStates();
    }


    function getPlayerList()
    {
      let playerData = JSON.parse(localStorage.getItem(PLAYER_LIST_KEY)) || [];
      return playerData;
    }


    function setPlayerList(players)
    {
      players.sort();
      localStorage.setItem(PLAYER_LIST_KEY, JSON.stringify(players));
    }


    function editPlayersClick(evt)
    {
      jQuery(".dataEntry").hide();

      let players = getPlayerList();
      if (players.length)
        jQuery("#editPlayerList").val(getPlayerList().join("\n") + "\n");

      jQuery(".playerDataEntry").show();
    }


    function helpClick(evt)
    {
      jQuery(".dataEntry").hide();
      jQuery(".helpContent").show();
    }


    function helpDismissClick(evt)
    {
      jQuery(".helpContent").hide();
      jQuery(".dataEntry").show();
    }


    function fillPlayerPulldowns()
    {
      // Delete all existing player options
      jQuery(".namePulldown option[name^=player-]").remove();

      // Populate player list into each pulldown
      for (let player of getPlayerList())
      {
        let opt = jQuery("<option>").attr("name", `player-${player}`).text(player);
        jQuery(".namePulldown").append(opt[0].outerHTML);
      }
    }


    function savePlayerListClick(evt)
    {
      let input = jQuery("#editPlayerList").val();
      let newPlayers = [];

      // Extract all things that look like player names (alphanumerics)
      let regex = /(\w+)/g;
      let m;
      while (m = regex.exec(input))
      {
        newPlayers.push(m[0]);
      }

      // Toggle back to game data entry
      jQuery(".playerDataEntry").hide();

      newPlayers.sort();
      setPlayerList(newPlayers);
      fillPlayerPulldowns();
      setStates();

      jQuery(".dataEntry").show();
    }


    function cancelPlayerListClick(evt)
    {
      // Toggle back to game data entry
      jQuery(".playerDataEntry").hide();
      jQuery(".dataEntry").show();
    }


    function deleteGameClick(evt)
    {
      // Remove the given game, then redraw the list (otherwise the offsets
      // will be all wrong after removing).
      let offset = evt.target.dataset.offset;
      let matches = getMatches();
      matches.splice(offset, 1);

      localStorage.setItem(STORAGE_KEY, JSON.stringify(matches));

      displayMatchData();
    }


    function gameStringClick(evt)
    {
      debugger;
      // Populate the form with the data from the game string.  Useful if
      // you want to "copy" an existing game's players.
      let gameData = JSON.parse(evt.target.dataset.gameresult);

      resetStates();

      let is1v1 = (gameData.win.length == 1);

      jQuery('#1v1').prop("checked", is1v1);
      jQuery('#2v2').prop("checked", !is1v1);

      jQuery('#t1-win,#t1-loss,#t2-win,#t2-loss').prop("checked", false);

      jQuery("#t1p1").val(gameData.win[0] || "");
      jQuery("#t1p2").val(gameData.win[1] || "");
      jQuery("#t2p1").val(gameData.lose[0] || "");
      jQuery("#t2p2").val(gameData.lose[1] || "");

      if (!is1v1)
      {
        jQuery("#t1p2").show();
        jQuery("#t2p2").show();
      }

      setStates();
    }


    jQuery(document).ready(function () {
      // Populate list of players if no saved player list exists
      if (getPlayerList().length === 0)
        setPlayerList([
          "dmmalone",
          "georgyue",
          "gunterj",
          "haimobai",
          "halpenny",
          "locknerp",
          "markajo",
          "scarbro",
          "tomwdlw",
        ]);

      fillPlayerPulldowns();

      // Set event handlers
      jQuery("#t1-win").click(winLossClick);
      jQuery("#t1-loss").click(winLossClick);
      jQuery("#t2-win").click(winLossClick);
      jQuery("#t2-loss").click(winLossClick);

      jQuery("#1v1").click(setStates);
      jQuery("#2v2").click(setStates);

      jQuery("#t1p1").change(setStates);
      jQuery("#t1p2").change(setStates);
      jQuery("#t2p1").change(setStates);
      jQuery("#t2p2").change(setStates);

      jQuery("#saveGame").click(saveGameClick);
      jQuery("#reset").click(resetStates);
      jQuery("#mailMatches").click(mailMatchesClick);

      jQuery("#clearMatches").click(clearMatchesClick);

      jQuery("#editPlayers").click(editPlayersClick);
      jQuery("#saveList").click(savePlayerListClick);
      jQuery("#cancelList").click(cancelPlayerListClick);

      jQuery("#help").click(helpClick);
      jQuery("#helpDismissClick").click(helpDismissClick);

      jQuery("#matchdata").on("click", ".deleteGame", deleteGameClick);
      jQuery("#matchdata").on("click", ".gameString", gameStringClick);

      displayMatchData();
    })
  </script>
</head>

<body>

  <div class="dataEntry">
    <fieldset id="gameTypeButtons">
      <legend>Game type</legend>
      <div>
        <label><input type="radio" name="gametype" id="2v2" checked="checked">2v2</label>
        <label><input type="radio" name="gametype" id="1v1" class="leftspace">1v1</label>
      </div>
    </fieldset>

    <fieldset id="team1">
      <legend>Team 1</legend>

      <div id="t1winlossButtons" class="winlossButtons">
        <label><input type="radio" name="t1winloss" id="t1-win">Win</label>
        <label><input type="radio" name="t1winloss" id="t1-loss" class="leftspace">Loss</label>
      </div>

      <select id="t1p1" class="namePulldown">
        <option value="" selected>Choose player...</option>
      </select>

      <select id="t1p2" class="namePulldown">
        <option value="" selected>Choose player...</option>
      </select>
    </fieldset>

    <fieldset id="team2">
      <legend>Team 2</legend>

      <div id="t2winlossButtons" class="winlossButtons">
        <label><input type="radio" name="t2winloss" id="t2-win">Win</label>
        <label><input type="radio" name="t2winloss" id="t2-loss" class="leftspace">Loss</label>
      </div>

      <select id="t2p1" class="namePulldown">
        <option value="" selected>Choose player...</option>
      </select>

      <select id="t2p2" class="namePulldown">
        <option value="" selected>Choose player...</option>
      </select>
    </fieldset>

    <div>
      <button id="saveGame">Save</button>
      <button id="reset">Reset</button>
      <button id="mailMatches">Mail</button>
    </div>

    <fieldset id="matches">
      <legend>Local saved matches</legend>
      <div id="matchdata">
      </div>
    </fieldset>

    <div>
      <button id="clearMatches">Clear Saved Matches</button>
      <button id="editPlayers">Edit Players</button>
    </div>

    <button id="help">Help</button>
  </div>

  <div id="playerEntry" class="playerDataEntry">
    <fieldset>
      <legend>Edit Players</legend>
      <textarea id="editPlayerList"></textarea>
      <div>
        <button id="saveList">Save</button>
        <button id="cancelList">Cancel</button>
      </div>
    </fieldset>
  </div>

  <div class="helpContent">
    Simple data entry form to save pong game data.
    <p>
    All information is saved locally to the device accessing the page.
    <p>
    When the Mail button is clicked, it will use your default mail
    application to construct an email, the recipient of which can take the
    match data and record it in pongbot chat.

    <div style="text-align: center;">
      <button id="helpDismissClick">Ok</button>
    </div>
  </div>
</body>
