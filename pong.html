<head>
  <title>Dumb Pong Match Recorder</title>

  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">

  <style>
    select {
      width: 15em;
    }

    #saveMatch {
      margin: 0.5em;
    }

    #clearMatches {
      margin: 0.5em;
    }

    #mailMatches {
      margin: 0.5em;
    }
  </style>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.18.1/URI.js"></script>

  <script>
    const STORAGE_KEY = "matchData";
    let players = [
      "baekc",
      "chengxw",
      "ddivyesh",
      "dmmalone",
      "georgyue",
      "gunterj",
      "haimobai",
      "halpenny",
      "jabeck",
      "locknerp",
      "markajo",
      "scarbro",
      "tomwdlw",
      "varshnes",
      "midha",
    ];

    players.sort();


    function switchTeamNumber(str)
    {
        if (str.search(/1/) !== -1) return str.replace(/1/, "2");
        if (str.search(/2/) !== -1) return str.replace(/2/, "1");
        throw new Error("unknown team id");
    }


    function hasSavedMatches()
    {
        return getMatches().length > 0;
    }


    function saveMatch(match)
    {
      let matchData = getMatches();
      matchData.push(match);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(matchData));
    }


    function getMatches()
    {
      let matchData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      return matchData;
    }


    function getWinLossStateForFieldsetId(set)
    {
      let $checked = jQuery(`#${set} input[type="radio"]:checked`);
      if ($checked.length === 0)
        return "";
      else if ($checked[0].id.search(/loss/) !== -1)
        return "l";

      return "w";
    }


    function setStates()
    {
      // Hide player 2 pulldowns on each team if 1v1 is selected (show them
      // otherwise)
      let is1v1 = jQuery('#1v1').prop("checked");
      if (is1v1)
      {
        jQuery("#t1p2").selectmenu("widget").hide();
        jQuery("#t2p2").selectmenu("widget").hide();
      }
      else
      {
        jQuery("#t1p2").selectmenu("widget").show();
        jQuery("#t2p2").selectmenu("widget").show();
      }

      let t1WinLoss = getWinLossStateForFieldsetId("t1winlossButtons");
      let t2WinLoss = getWinLossStateForFieldsetId("t2winlossButtons");

      // First, ensure all options are enabled
      jQuery("#t1p1 option").prop("disabled", false);
      jQuery("#t1p2 option").prop("disabled", false);
      jQuery("#t2p1 option").prop("disabled", false);
      jQuery("#t2p2 option").prop("disabled", false);

      // Then, disable each selected player in all other select tags
      let t1p1 = jQuery("#t1p1");
      let t1p2 = jQuery("#t1p2");
      let t2p1 = jQuery("#t2p1");
      let t2p2 = jQuery("#t2p2");

      for (el1 of [t1p1, t1p2, t2p1, t2p2])
      {
        let p = el1.val();
        if (!p)
          continue;

        // Disable all players of that name
        jQuery(`option[name="player-${p}"]`).prop("disabled", true);
        // Then re-enable the one that was originally set
        jQuery(`option[name="player-${p}"]`, el1).prop("disabled", false);
      }

      // Save can only be done if required fields have values
      jQuery("#saveMatch").button(
        (is1v1 && (t1p1.val() && t2p1.val()) ||
          (t1p1.val() && t1p2.val() && t2p1.val() && t2p2.val())) &&
        t1WinLoss && t2WinLoss ? "enable" : "disable");

      // Mail can only be done if at least one match is saved
      jQuery("#mailMatches").button(hasSavedMatches() ? "enable" : "disable");
    }


    function winLossClick(evt)
    {
      let isWin = evt.target.id.search(/win/) !== -1;
      let prefix = evt.target.id.replace(/-.*$/, "");
      let otherTeamPrefix = switchTeamNumber(prefix);

      // Toggle the other team's win/loss buttons
      jQuery(`#${otherTeamPrefix}-${isWin ? "win" : "loss"}`).prop("checked", false).change();
      jQuery(`#${otherTeamPrefix}-${isWin ? "loss" : "win"}`).prop("checked", true).change();

      setStates();
    }


    function gameTypeClick(evt)
    {
      setStates();
    }


    function saveMatchClick(evt)
    {
      debugger;
      let match = {};
      let gameType = jQuery('#gameTypeButtons input[type="radio"]:checked:first')[0].id;
      let t1p1 = jQuery("#t1p1").val();
      let t1p2 = jQuery("#t1p2").val();
      let t2p1 = jQuery("#t2p1").val();
      let t2p2 = jQuery("#t2p2").val();
      let $t1winLoss = jQuery('#t1winlossButtons input[type="radio"]:checked:first');
      if ($t1winLoss.length > 0)
      {
        match.timestamp = (new Date).toISOString();

        if ($t1winLoss[0].id === "t1-win")
        {
          match.winTeam = [ t1p1, t1p2 ].join(",");
          match.loseTeam = [ t2p1, t2p2 ].join(",");
        }
        else
        {
          match.winTeam = [ t2p1, t2p2 ].join(",");
          match.loseTeam = [ t1p1, t1p2 ].join(",");
        }
      }

      saveMatch(match);
      displayMatchData();
    }


    function clearMatchesClick(evt)
    {
      localStorage.removeItem(STORAGE_KEY);
      displayMatchData();
    }


    function mailMatchesClick(evt)
    {
      let body = []
      for (let match of (localStorage.getItem(STORAGE_KEY) || []))
      {
        match = JSON.parse(match);
        body.push(`/pong record \"${match.timestamp}\" w:${match.winTeam} l:${match.loseTeam}`);
      }

      //let url = new URI("mailto:automotive-pongbot@amazon.com");
      let url = new URI("mailto:paxunix@gmail.com");
      url.setSearch({
        subject: "Pong Match",
        body: body.join("\n"),
      });

      window.open(url.toString(), "pongbot mail window");
    }


    function displayMatchData()
    {
      // Iterate through locally saved match data and output mailto URLs
      // with match data.
      jQuery("#matchdata").html("");

      let matches = (localStorage.getItem(STORAGE_KEY) || "[]");
      try {
        matches = JSON.parse(matches);
      }
      catch (e) {
        // If anything goes wrong with parsing, throw away the data
        localStorage.removeItem(STORAGE_KEY);
        matches = []
      }

      for (let match of matches)
      {

        let matchRecordString = `/pong record \"${match.timestamp}\" w:${match.winTeam} l:${match.loseTeam}`;

        let url = new URI("mailto:automotive-pongbot@amazon.com");
        url.setSearch({
          subject: "Pong Match",
          body: matchRecordString,
        });

        let mailto = jQuery("<a>")
          .attr("href", url.toString())
          .text(matchRecordString)

        jQuery("#matchdata").append(mailto).append("<p>");
      }

      setStates();
    }


    jQuery(document).ready(function () {
      // Populate each select with all players
      for (selectId of ["t1p1", "t1p2", "t2p1", "t2p2"])
      {
        for (p of players)
        {
          let opt = jQuery("<option>").attr("name", `player-${p}`).text(p);
          jQuery(`#${selectId}`).append(opt);
        }
      }


      // Set event handlers and jQuery UI elements
      jQuery("#t1-win").click(winLossClick);
      jQuery("#t1-loss").click(winLossClick);
      jQuery("#t2-win").click(winLossClick);
      jQuery("#t2-loss").click(winLossClick);

      jQuery("#1v1").click(gameTypeClick);
      jQuery("#2v2").click(gameTypeClick);

      jQuery("#gameTypeButtons").buttonset({ items: "input" });
      jQuery("#t1winlossButtons").buttonset({ items: "input" });
      jQuery("#t2winlossButtons").buttonset({ items: "input" });

      jQuery("#t1p1").selectmenu();
      jQuery("#t1p2").selectmenu();
      jQuery("#t2p1").selectmenu();
      jQuery("#t2p2").selectmenu();

      jQuery("#saveMatch").click(saveMatchClick).button();
      jQuery("#clearMatches").click(clearMatchesClick).button();
      jQuery("#mailMatches").click(mailMatchesClick).button();

      displayMatchData();
    })
  </script>
</head>

<body>

  <fieldset id="gameTypeButtons">
    <legend>Game type</legend>
    <label for="2v2">2v2</label>
    <input type="radio" name="gametype" id="2v2" checked="checked">
    <label for="1v1">1v1</label>
    <input type="radio" name="gametype" id="1v1">
  </fieldset>

  <fieldset id="team1">
    <legend>Team 1</legend>

    <div id="t1winlossButtons">
      <label for="t1-win">W</label>
      <input type="radio" name="t1winloss" id="t1-win">
      <label for="t1-loss">L</label>
      <input type="radio" name="t1winloss" id="t1-loss">
    </div>

    <div>
    <select id="t1p1">
      <option value="" selected>Choose player...</option>
    </select>
    </div>

    <select id="t1p2">
      <option value="" selected>Choose player...</option>
    </select>
  </fieldset>

  <fieldset id="team2">
    <legend>Team 2</legend>

    <div id="t2winlossButtons">
      <label for="t2-win">W</label>
      <input type="radio" name="t2winloss" id="t2-win">
      <label for="t2-loss">L</label>
      <input type="radio" name="t2winloss" id="t2-loss">
    </div>

    <div>
    <select id="t2p1">
      <option value="" selected>Choose player...</option>
    </select>
    </div>

    <select id="t2p2">
      <option value="" selected>Choose player...</option>
    </select>
  </fieldset>

  <button id="saveMatch">Save</button> <button id="clearMatches">Clear</button> <button id="mailMatches">Mail</button>

  <fieldset id="matches">
    <legend>Local saved match data</legend>
    <div id="matchdata">
    </div>
  </fieldset>
</body>
